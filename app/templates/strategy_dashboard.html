<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Strategy Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-dark text-white">

<div class="container mt-4">

    <h2 class="mb-3">Strategy Rules</h2>
    <table class="table table-dark table-striped align-middle">
        <thead>
            <tr>
                <th>ID</th>
                <th>Action</th>
                <th>Condition</th>
                <th>Enabled</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for r in rules %}
            <tr>
                <td>{{ r.id }}</td>
                <td>{{ r.action }}</td>
                <td>{{ r.condition_type }}</td>
                <td>
                    {% if r.enabled %}
                        <span class="badge bg-success">Enabled</span>
                    {% else %}
                        <span class="badge bg-danger">Disabled</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editRule({{ r.id }}, '{{ r.action }}', '{{ r.condition_type }}', {{ 1 if r.enabled else 0 }})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteRule({{ r.id }})">Delete</button>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="5" class="text-center text-secondary">No rules found</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h2 class="mb-3">Strategy Sets</h2>
    <table class="table table-dark table-striped align-middle">
        <thead>
            <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>Name</th>
            </tr>
        </thead>
        <tbody>
        {% for s in sets %}
            <tr>
                <td>{{ s.id }}</td>
                <td>{{ s.user_id }}</td>
                <td>{{ s.name }}</td>
            </tr>
        {% else %}
            <tr>
                <td colspan="3" class="text-center text-secondary">No sets found</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h2 class="mb-3">Strategy Weights</h2>
    <table class="table table-dark table-striped align-middle">
        <thead>
            <tr>
                <th>User ID</th>
                <th>Exchange</th>
                <th>Pair</th>
                <th>RSI Weight</th>
                <th>Forecast Weight</th>
                <th>Acceleration Weight</th>
                <th>Trade Logic</th>
            </tr>
        </thead>
        <tbody>
        {% for w in weights %}
            <tr>
                <td>{{ w.user_id }}</td>
                <td>{{ w.exchange }}</td>
                <td>{{ w.pair }}</td>
                <td>{{ w.rsi_weight }}</td>
                <td>{{ w.forecast_weight }}</td>
                <td>{{ w.acceleration_weight }}</td>
                <td>{{ w.trade_logic }}</td>
            </tr>
        {% else %}
            <tr>
                <td colspan="7" class="text-center text-secondary">No weights found</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal for Editing Rule -->
<div class="modal" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Edit Strategy Rule</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="ruleId">
        <div class="mb-3">
          <label>Action</label>
          <input type="text" class="form-control" id="ruleAction">
        </div>
        <div class="mb-3">
          <label>Condition</label>
          <input type="text" class="form-control" id="ruleCondition">
        </div>
        <div class="mb-3">
          <label>Enabled</label>
          <select class="form-control" id="ruleEnabled">
            <option value="1">Enabled</option>
            <option value="0">Disabled</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveRule()">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
async function deleteRule(id) {
    if (!confirm("Are you sure you want to delete this rule?")) return;
    const resp = await fetch(`/api/strategy_rules/${id}`, { method: 'DELETE' });
    if (resp.ok) location.reload();
}

function editRule(id, action, condition, enabled) {
    document.getElementById('ruleId').value = id;
    document.getElementById('ruleAction').value = action;
    document.getElementById('ruleCondition').value = condition;
    document.getElementById('ruleEnabled').value = enabled;
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

async function saveRule() {
    const id = document.getElementById('ruleId').value;
    const data = {
        action: document.getElementById('ruleAction').value,
        condition: document.getElementById('ruleCondition').value,
        enabled: document.getElementById('ruleEnabled').value === "1"
    };
    const resp = await fetch(`/api/strategy_rules/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    if (resp.ok) location.reload();
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Strategy Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    .table-dark th { text-align: center; }
    .form-control, .form-select { margin-right: 5px; }
    .gap-2 > * { margin-right: .5rem; }
  </style>
</head>
<body>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Strategy Dashboard</h3>
    <a class="btn btn-outline-danger" href="/logout">Logout</a>
  </div>
  <!-- ===================== filters ======================================= -->
  <div class="mb-3 d-flex gap-2">
    <select id="filter_user" class="form-select" style="max-width:200px">
      <option value="">All Users</option>
    </select>
    <select id="filter_exchange" class="form-select" style="max-width:200px">
      <option value="">All Exchanges</option>
    </select>
    <select id="filter_pair" class="form-select" style="max-width:200px">
      <option value="">All Pairs</option>
    </select>
  </div>
  <!-- ===================== Sets and Rules ======================================= -->
   <div class="card mt-3">
  <div class="card-header d-flex align-items-center">
    <strong>Rules in Set</strong>
    <select id="setSelect" class="form-select ms-3" style="max-width:240px"></select>
    <div class="ms-auto d-flex" style="gap:.5rem">
      <select id="ruleSelect" class="form-select" style="max-width:260px"></select>
      <input id="rulePriority" class="form-control" type="number" min="0" value="100" style="max-width:110px">
<!-- тимчасово прибрати, вони ламають виклики -->
<!-- <input ... oninput="onPriorityInput(SET_ID, RULE_ID, this)"> -->
<!-- <input ... onchange="toggleSetRuleEnabled(SET_ID, RULE_ID, this.checked)"> -->
      <button class="btn btn-primary" onclick="attachRule()">Attach</button>
    </div>
  </div>
  <div class="card-body p-0">
    <table class="table table-sm mb-0">
      <thead class="table-dark">
        <tr><th>ID</th><th>Action</th><th>Condition</th><th>P1</th><th>P2</th>
            <th>Priority</th><th>Enabled</th><th>Note</th><th>Actions</th></tr>
      </thead>
      <tbody id="setRulesTbody"></tbody>
    </table>
  </div>
</div>
  <!-- ===================== Strategy Rules ===================== -->
  <h4 class="mb-2">Strategy Rules</h4>
  <div class="mb-3 p-3 border rounded bg-white">
    <div class="d-flex flex-wrap">
      <select id="action" class="form-select" style="max-width:160px">
        <option value="BUY">BUY</option>
        <option value="SELL">SELL</option>
      </select>

      <input id="condition_type" class="form-control" placeholder="Condition Type (e.g., RSI_ABOVE)">
      <input id="param_1" class="form-control" placeholder="Param1">
      <input id="param_2" class="form-control" placeholder="Param2">

      <div class="form-check align-self-center ms-2 me-2">
        <input class="form-check-input" type="checkbox" id="enabled" checked>
        <label class="form-check-label" for="enabled">Enabled</label>
      </div>

      <input id="exchange" class="form-control" placeholder="Exchange (e.g., binance)">
      <input id="pair" class="form-control" placeholder="Pair (e.g., BTCUSDT)">
      <input id="priority" type="number" class="form-control" placeholder="Priority" style="max-width:140px">

      <button id="addRuleBtn" type="button" class="btn btn-success">Add</button>
    </div>
  </div>

  <table class="table table-striped table-hover table-bordered">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Action</th>
        <th>Condition</th>
        <th>Param1</th>
        <th>Param2</th>
        <th>Enabled</th>
        <th>Exchange</th>
        <th>Pair</th>
        <th>Priority</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="rulesTable"></tbody>
  </table>

  <hr class="my-4">

  <!-- ===================== Strategy Sets ===================== -->
  <h4 class="mb-2">Strategy Sets</h4>
  <div class="mb-3 p-3 border rounded bg-white">
    <div class="d-flex flex-wrap gap-2">
      <input id="set_name" class="form-control" placeholder="Set name (e.g., Default Binance)">
      <input id="set_desc" class="form-control" placeholder="Description">
      <input id="set_exchange" class="form-control" placeholder="Exchange (optional)">
      <input id="set_pair" class="form-control" placeholder="Pair (optional)">
      <div class="form-check align-self-center ms-2">
        <input class="form-check-input" type="checkbox" id="set_active">
        <label class="form-check-label" for="set_active">Active</label>
      </div>
      <button id="addSetBtn" type="button" class="btn btn-success">Add Set</button>
    </div>
  </div>

  <table class="table table-striped table-hover table-bordered">
    <thead class="table-dark">
      <tr>
        <th>ID</th><th>Name</th><th>Active</th><th>Exchange</th><th>Pair</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="setsTable"></tbody>
  </table>

  <!-- Manage Set Rules Modal -->
  <div class="modal fade" id="manageSetRulesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Set Rules</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <h6>All Rules</h6>
              <div id="allRulesList" class="list-group" style="max-height:400px; overflow:auto;"></div>
            </div>
            <div class="col-md-6">
              <h6>Rules in Set</h6>
              <div id="setRulesList" class="list-group" style="max-height:400px; overflow:auto;"></div>
            </div>
          </div>
          <small class="text-muted d-block mt-2">Праворуч можна увімкнути/вимкнути правило і задати локальний пріоритет.</small>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <hr class="my-4">

  <!-- ===================== Strategy Weights ===================== -->
  <h4 class="mb-2">Strategy Weights</h4>
  <div class="mb-3 p-3 border rounded bg-white">
    <div class="d-flex flex-wrap gap-2">
      <input id="w_exchange" class="form-control" placeholder="Exchange (e.g., binance)">
      <input id="w_pair" class="form-control" placeholder="Pair (e.g., BTCUSDT)">
      <input id="w_rsi" type="number" step="0.1" class="form-control" placeholder="RSI weight" value="1.0" style="max-width:160px">
      <input id="w_forecast" type="number" step="0.1" class="form-control" placeholder="Forecast weight" value="1.0" style="max-width:180px">
      <input id="w_accel" type="number" step="0.1" class="form-control" placeholder="Acceleration weight" value="1.0" style="max-width:200px">
      <select id="w_logic" class="form-select" style="max-width:180px">
        <option value="COMBINER">COMBINER</option>
        <option value="THRESHOLD">THRESHOLD</option>
        <option value="VOTE">VOTE</option>
      </select>
      <button id="saveWeightsBtn" type="button" class="btn btn-success">Save</button>
    </div>
  </div>

  <table class="table table-striped table-hover table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Exchange</th><th>Pair</th><th>RSI</th><th>Forecast</th><th>Accel</th><th>Logic</th><th>Updated</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="weightsTable"></tbody>
  </table>

  <!-- ========= Modals: Edit Rule ========= -->
  <div class="modal fade" id="editRuleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Rule</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editRuleForm">
            <input type="hidden" id="er_id">
            <div class="row g-2 mb-2">
              <div class="col">
                <label class="form-label">Action</label>
                <select id="er_action" class="form-select">
                  <option value="BUY">BUY</option>
                  <option value="SELL">SELL</option>
                </select>
              </div>
              <div class="col">
                <label class="form-label">Condition</label>
                <input id="er_condition" class="form-control" placeholder="RSI_ABOVE">
              </div>
            </div>
            <div class="row g-2 mb-2">
              <div class="col">
                <label class="form-label">Param1</label>
                <input id="er_p1" class="form-control">
              </div>
              <div class="col">
                <label class="form-label">Param2</label>
                <input id="er_p2" class="form-control">
              </div>
            </div>
            <div class="row g-2 mb-2">
              <div class="col">
                <label class="form-label">Exchange</label>
                <input id="er_exchange" class="form-control">
              </div>
              <div class="col">
                <label class="form-label">Pair</label>
                <input id="er_pair" class="form-control">
              </div>
            </div>
            <div class="row g-2 mb-2">
              <div class="col">
                <label class="form-label">Priority</label>
                <input id="er_priority" type="number" class="form-control">
              </div>
              <div class="col d-flex align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="er_enabled">
                  <label class="form-check-label" for="er_enabled">Enabled</label>
                </div>
              </div>
            </div>
          </form>
          <small class="text-muted">Тільки змінені поля підуть у PUT.</small>
        </div>
        <div class="modal-footer">
          <button id="er_saveBtn" type="button" class="btn btn-primary">Save</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
   <!-- ========= Modal: Edit Strategy Set ========= -->
   <div class="modal fade" id="editSetModal" tabindex="-1" aria-hidden="true">
     <div class="modal-dialog">
       <div class="modal-content">
         <div class="modal-header">
           <h5 class="modal-title">Edit Strategy Set</h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
         </div>
         <div class="modal-body">
           <form id="editSetForm">
             <input type="hidden" id="es_id">
             <div class="mb-2">
               <label class="form-label">Name</label>
               <input id="es_name" class="form-control" maxlength="50">
             </div>
             <div class="mb-2">
               <label class="form-label">Description</label>
               <textarea id="es_desc" class="form-control" rows="2"></textarea>
             </div>
             <div class="row g-2 mb-2">
               <div class="col">
                 <label class="form-label">Exchange</label>
                 <input id="es_exchange" class="form-control">
               </div>
               <div class="col">
                 <label class="form-label">Pair</label>
                 <input id="es_pair" class="form-control">
               </div>
             </div>
             <div class="form-check">
               <input class="form-check-input" type="checkbox" id="es_active">
               <label class="form-check-label" for="es_active">Active</label>
             </div>
           </form>
         </div>
         <div class="modal-footer">
           <button id="es_saveBtn" type="button" class="btn btn-primary">Save</button>
           <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
         </div>
       </div>
     </div>
   </div>
    <!-- =============== Scripts =============== -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- apiFetch helper (єдине місце) -->
    <script>
      async function apiFetch(url, options = {}) {
        const token = localStorage.getItem('access_token');
        const headers = options.headers || {};
        headers['Content-Type'] = 'application/json';
        if (token) headers['Authorization'] = `Bearer ${token}`;
        return fetch(url, { ...options, headers });
      }
      function escapeHtml(s){return (s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
    </script>
    
    <!-- Твій JS -->
    <script src="/static/js/strategy.js?v=2025-08-09-1"></script>
    <script src="/static/js/strategy_sets.js?v=2025-08-09-1"></script>
    <script src="/static/js/strategy_weights.js?v=2025-08-09-1"></script>
    <script src="/static/js/strategy_sets_rules.js?v=2025-08-09-2"></script>
    
    <!-- Фільтри + єдина ініціалізація -->
    <script>
      // !!! шлях має збігатися з тим, що бачиш у /docs
      // якщо виніс у окремий роутер з prefix="/api/filters", зміни на '/api/filters/user-active-pairs'
      const FILTERS_URL = '/api/strategy_rules/filters/user-active-pairs';
    
      function option(label, value='') {
        const o = document.createElement('option');
        o.value = value ?? '';
        o.textContent = label ?? '';
        return o;
      }
      function fillSelect(id, values, allLabel, keepValue) {
        const el = document.getElementById(id);
        const keep = keepValue ?? el.value ?? '';
        el.innerHTML = '';
        el.appendChild(option(allLabel, ''));
        values.forEach(v => el.appendChild(option(String(v), String(v))));
        if (keep && [...el.options].some(o => o.value === String(keep))) {
          el.value = String(keep);
        }
      }
    
      async function loadFilters(partial = {}) {
        const prev = {
          user: document.getElementById('filter_user')?.value || '',
          ex:   document.getElementById('filter_exchange')?.value || '',
          pair: document.getElementById('filter_pair')?.value || '',
        };
        const qs = new URLSearchParams();
        Object.entries(partial).forEach(([k,v]) => v && qs.append(k, v));
        const url = qs.toString() ? `${FILTERS_URL}?${qs}` : FILTERS_URL;
    
        console.log('[filters] GET', url);
        const r = await apiFetch(url);
        if (!r.ok) { console.error('filters error', r.status); return; }
        const data = await r.json();
        console.log('[filters] data', data);
    
        fillSelect('filter_user', data.users || [], 'All Users', prev.user);
        fillSelect('filter_exchange', data.exchanges || [], 'All Exchanges', prev.ex);
        fillSelect('filter_pair', data.pairs || [], 'All Pairs', prev.pair);
      }
    
      async function onFilterChange() {
        const user_id = document.getElementById('filter_user').value || '';
        const exchange = document.getElementById('filter_exchange').value || '';
        await loadFilters({ user_id, exchange });   // каскад
        if (typeof loadRules === 'function')   await loadRules();   // бере активні селекти всередині
        if (typeof loadSets === 'function')    await loadSets();
        if (typeof loadWeights === 'function') await loadWeights();
      }
    
      window.addEventListener('DOMContentLoaded', async () => {
        console.log('[init] Strategy Dashboard');

        document.getElementById('er_saveBtn')?.addEventListener('click', async () => {
            const id = window.__editRuleId__;
            const body = window.__gatherEditPayload__?.();
            if (!id || !body) return;
            await updateRule(id, body);
        });

        // кнопки модалок/створення — залишаємо як у твоїх файлах JS
        const addBtn   = document.getElementById('addRuleBtn');
        if (addBtn) addBtn.addEventListener('click', e => { e.preventDefault(); addRule?.(); });
    
        const erSaveBtn = document.getElementById('er_saveBtn');
        if (erSaveBtn) erSaveBtn.addEventListener('click', async () => {
          if (!window.__editRuleId__) return;
          const body = window.__gatherEditPayload__?.();
          await updateRule?.(window.__editRuleId__, body);
          const modal = bootstrap.Modal.getInstance(document.getElementById('editRuleModal'));
          modal?.hide();
        });
    
        const addSetBtn = document.getElementById('addSetBtn');
        if (addSetBtn) addSetBtn.addEventListener('click', e => { e.preventDefault(); addSet?.(); });
    
        const esSaveBtn = document.getElementById('es_saveBtn');
        if (esSaveBtn) esSaveBtn.addEventListener('click', async () => {
          if (!window.__editSetId__) return;
          const body = window.__gatherSetEditPayload__?.();
          await updateSet?.(window.__editSetId__, body);
          const modal = bootstrap.Modal.getInstance(document.getElementById('editSetModal'));
          modal?.hide();
        });
    
        const saveWeightsBtn = document.getElementById('saveWeightsBtn');
        if (saveWeightsBtn) saveWeightsBtn.addEventListener('click', e => { e.preventDefault(); upsertWeights?.(); });
    
        // 1) тягнемо фільтри
        await loadFilters();
    
        // 2) вішаємо change
        ['filter_user','filter_exchange','filter_pair'].forEach(id => {
          document.getElementById(id)?.addEventListener('change', onFilterChange);
        });
    
        // 3) стартові дані таблиць
        if (typeof loadRules === 'function')   await loadRules();
        if (typeof loadSets === 'function')    await loadSets();
        if (typeof loadWeights === 'function') await loadWeights();
      });
    </script>
</body>
</html>

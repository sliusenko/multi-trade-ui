<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Strategy Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-dark text-white">

<div class="container mt-4">

    <!-- Strategy Rules -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Strategy Rules</h2>
        <button class="btn btn-success btn-sm" onclick="showAddModal()">Add Rule</button>
    </div>
    <table class="table table-dark table-striped align-middle" id="rulesTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Action</th>
                <th>Condition</th>
                <th>Enabled</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="rulesBody">
        {% for r in rules %}
            <tr id="rule-{{ r.id }}">
                <td>{{ r.id }}</td>
                <td>{{ r.action }}</td>
                <td>{{ r.condition_type }}</td>
                <td>
                    {% if r.enabled %}
                        <span class="badge bg-success">Enabled</span>
                    {% else %}
                        <span class="badge bg-danger">Disabled</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editRule({{ r.id }}, '{{ r.action }}', '{{ r.condition_type }}', {{ 1 if r.enabled else 0 }})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteRule({{ r.id }})">Delete</button>
                </td>
            </tr>
        {% else %}
            <tr id="no-rules">
                <td colspan="5" class="text-center text-secondary">No rules found</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

</div>

<!-- Modal for Editing Rule -->
<div class="modal" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Edit Strategy Rule</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="ruleId">
        <div class="mb-3">
          <label>Action</label>
          <input type="text" class="form-control" id="ruleAction">
        </div>
        <div class="mb-3">
          <label>Condition</label>
          <input type="text" class="form-control" id="ruleCondition">
        </div>
        <div class="mb-3">
          <label>Enabled</label>
          <select class="form-control" id="ruleEnabled">
            <option value="1">Enabled</option>
            <option value="0">Disabled</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveRule()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Adding Rule -->
<div class="modal" id="addModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Add Strategy Rule</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label>Action</label>
          <input type="text" class="form-control" id="newRuleAction">
        </div>
        <div class="mb-3">
          <label>Condition</label>
          <input type="text" class="form-control" id="newRuleCondition">
        </div>
        <div class="mb-3">
          <label>Enabled</label>
          <select class="form-control" id="newRuleEnabled">
            <option value="1">Enabled</option>
            <option value="0">Disabled</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="addRule()">Add</button>
      </div>
    </div>
  </div>
</div>

<script>
async function deleteRule(id) {
    if (!confirm("Are you sure you want to delete this rule?")) return;
    const resp = await fetch(`/api/strategy_rules/${id}`, { method: 'DELETE' });
    if (resp.ok) {
        document.getElementById(`rule-${id}`)?.remove();
        if (!document.querySelector('#rulesBody tr')) {
            document.getElementById('rulesBody').innerHTML =
                '<tr id="no-rules"><td colspan="5" class="text-center text-secondary">No rules found</td></tr>';
        }
    }
}

function editRule(id, action, condition, enabled) {
    document.getElementById('ruleId').value = id;
    document.getElementById('ruleAction').value = action;
    document.getElementById('ruleCondition').value = condition;
    document.getElementById('ruleEnabled').value = enabled;
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

async function saveRule() {
    const id = document.getElementById('ruleId').value;
    const data = {
        action: document.getElementById('ruleAction').value,
        condition_type: document.getElementById('ruleCondition').value,
        enabled: document.getElementById('ruleEnabled').value === "1"
    };

    const resp = await fetch(`/api/strategy_rules/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    if (resp.ok) {
        const row = document.getElementById(`rule-${id}`);
        if (row) {
            row.cells[1].innerText = data.action;
            row.cells[2].innerText = data.condition_type;
            row.cells[3].innerHTML = data.enabled
                ? '<span class="badge bg-success">Enabled</span>'
                : '<span class="badge bg-danger">Disabled</span>';
        }
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    }
}

function showAddModal() {
    new bootstrap.Modal(document.getElementById('addModal')).show();
}

async function addRule() {
    const data = {
        action: document.getElementById('newRuleAction').value,
        condition_type: document.getElementById('newRuleCondition').value,
        enabled: document.getElementById('newRuleEnabled').value === "1"
    };

    const resp = await fetch(`/api/strategy_rules`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    if (resp.ok) {
        const result = await resp.json();
        document.getElementById('no-rules')?.remove();

        const newRow = document.createElement('tr');
        newRow.id = `rule-${result.id}`;
        newRow.innerHTML = `
            <td>${result.id}</td>
            <td>${data.action}</td>
            <td>${data.condition_type}</td>
            <td>${data.enabled
                ? '<span class="badge bg-success">Enabled</span>'
                : '<span class="badge bg-danger">Disabled</span>'}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editRule(${result.id}, '${data.action}', '${data.condition_type}', ${data.enabled ? 1 : 0})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteRule(${result.id})">Delete</button>
            </td>
        `;
        document.getElementById('rulesBody').appendChild(newRow);

        // Очистка форми та закриття модалки
        document.getElementById('newRuleAction').value = '';
        document.getElementById('newRuleCondition').value = '';
        document.getElementById('newRuleEnabled').value = '1';
        bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
    } else {
        alert("Failed to add rule");
    }
}
</script>

</body>
</html>
